<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EHS Permit-to-Work System</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f4f7f6; margin:0; color:#333; }
header { text-align:center; padding:15px; background:#0d6efd; color:white; font-size:1.5em; }
nav { display:flex; justify-content:center; margin:10px 0; }
nav button { margin:0 5px; padding:10px 15px; border:none; border-radius:5px; background:#e9ecef; cursor:pointer; transition:0.3s;}
nav button.active, nav button:hover { background:#0d6efd; color:#fff;}
.container { max-width:1200px; margin:auto; padding:10px; }
input, select, button, textarea { padding:8px; margin:5px 0; border-radius:5px; border:1px solid #ccc; width:100%; }
button { cursor:pointer; background:#0d6efd; color:#fff; border:none; transition:0.3s; }
button:hover { background:#0b5ed7; }
label { font-weight:bold; display:block; margin-top:5px; }
.card { background:#fff; padding:15px; margin-bottom:15px; border-radius:10px; box-shadow:0 3px 6px rgba(0,0,0,0.1); transition:0.3s; }
.card:hover { box-shadow:0 6px 12px rgba(0,0,0,0.2); }
.badge { padding:4px 8px; border-radius:5px; color:white; font-size:0.8em; font-weight:bold; }
.badge-Draft { background:#6c757d; }
.badge-Pending { background:#ffc107; color:#212529; }
.badge-Approved { background:#0d6efd; }
.badge-Active { background:#198754; }
.badge-Closed { background:#6c757d; }
.badge-Rejected { background:#dc3545; }
.badge-Suspended { background:#fd7e14; }
.summary-card { display:inline-block; width:23%; margin:1%; padding:15px; background:#fff; border-radius:10px; text-align:center; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
.summary-card h3 { margin:5px 0; }
.permit-header { display:flex; justify-content: space-between; align-items:center; margin-bottom:10px; }
.permit-title { font-size:1.1em; font-weight:bold; }
.permit-icons i { margin-left:5px; color:#0d6efd; }
.page { display:block; }
table { width:100%; border-collapse: collapse; margin-top:10px;}
th, td { border:1px solid #ccc; padding:8px; text-align:left; }
th { background:#0d6efd; color:white; }
</style>
</head>
<body>
<header><i class="fas fa-hard-hat"></i> EHS Permit-to-Work System</header>

<div class="container">
<!-- Login Page -->
<div id="loginPage" class="page">
<div class="card">
<h2><i class="fas fa-sign-in-alt"></i> Login</h2>
<label>Username</label><input type="text" id="username" placeholder="Username">
<label>Password</label><input type="password" id="password" placeholder="Password">
<button onclick="login()"><i class="fas fa-sign-in-alt"></i> Login</button>
</div>
</div>

<!-- Dashboard Page -->
<div id="dashboardPage" class="page" style="display:none;">
<div class="card">
<h2>Welcome, <span id="userDisplay"></span></h2>
<p>Your role: <b id="roleDisplay"></b></p>
<button onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
</div>
<nav id="roleNav"></nav>
<div id="contentSection"></div>
</div>
</div>

<script>
// Initialize data
let users = JSON.parse(localStorage.getItem('users')||'[]');
let permits = JSON.parse(localStorage.getItem('permits')||'[]');
let currentUser = null;

// Default admin
if(!users.some(u=>u.role==='admin')) 
    users.push({username:'ptwadmin', password:'ptwadmin', role:'admin'});
localStorage.setItem('users', JSON.stringify(users));

// Login
function login(){
  const username=document.getElementById('username').value;
  const password=document.getElementById('password').value;
  const user=users.find(u=>u.username===username && u.password===password);
  if(!user){ alert("Invalid credentials"); return; }
  currentUser=user;
  document.getElementById('userDisplay').innerText=user.username;
  document.getElementById('roleDisplay').innerText=user.role;
  document.getElementById('loginPage').style.display='none';
  document.getElementById('dashboardPage').style.display='block';
  renderNav();
  showSection(currentUser.role==='admin'?'userManagement':'permitManagement');
}

// Logout
function logout(){
  currentUser=null;
  document.getElementById('loginPage').style.display='block';
  document.getElementById('dashboardPage').style.display='none';
}

// Render navigation
function renderNav(){
  const nav=document.getElementById('roleNav'); nav.innerHTML='';
  if(currentUser.role==='admin'){
    nav.innerHTML=`<button onclick="showSection('userManagement')">User Management</button>
                   <button onclick="showSection('permitManagement')">Permit Management</button>`;
  }else nav.innerHTML=`<button onclick="showSection('permitManagement')">Permit Management</button>`;
}

// Show section
function showSection(section){
  renderContent(section);
}

// Render content
function renderContent(section){
  const content=document.getElementById('contentSection'); content.innerHTML='';
  if(section==='userManagement' && currentUser.role==='admin'){
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`<h3>User Management</h3>
      <label>Username</label><input type="text" id="newUsername">
      <label>Password</label><input type="text" id="newPassword">
      <label>Role</label>
      <select id="newRole">
        <option value="holder">Permit Holder</option>
        <option value="verifier">Verifier</option>
        <option value="issuer">Issuer</option>
        <option value="admin">Admin</option>
      </select>
      <button onclick="addUser()"><i class="fas fa-user-plus"></i> Add User</button>
      <h4>Existing Users</h4><div id="userList"></div>`;
    content.appendChild(card);
    renderUserList();
  } else if(section==='permitManagement'){
    renderPermitManagement(content);
  }
}

// User Management
function addUser(){
  const username=document.getElementById('newUsername').value;
  const password=document.getElementById('newPassword').value;
  const role=document.getElementById('newRole').value;
  if(!username || !password){ alert('Enter username & password'); return; }
  if(users.some(u=>u.username===username)){ alert('User exists'); return; }
  users.push({username,password,role});
  localStorage.setItem('users', JSON.stringify(users));
  alert('User added!');
  document.getElementById('newUsername').value='';
  document.getElementById('newPassword').value='';
  renderUserList();
}

function renderUserList(){
  const ul=document.getElementById('userList'); ul.innerHTML='';
  users.forEach(u=>{
    const div=document.createElement('div'); 
    div.innerHTML=`${u.username} [${u.role}] <button onclick="removeUser('${u.username}')"><i class="fas fa-trash"></i> Remove</button>`;
    ul.appendChild(div);
  });
}

function removeUser(username){
  if(!confirm(`Delete user ${username}?`)) return;
  users=users.filter(u=>u.username!==username);
  localStorage.setItem('users', JSON.stringify(users));
  renderUserList();
}

// Permit Management
function renderPermitManagement(container){
  // Summary cards
  const total = permits.length;
  const active = permits.filter(p=>p.status==='Active').length;
  const suspended = permits.filter(p=>p.status==='Suspended').length;
  const rejected = permits.filter(p=>p.status==='Rejected').length;
  const summaryHtml = `<div class="summary-card"><h3>Total</h3><p>${total}</p></div>
                       <div class="summary-card"><h3>Active</h3><p>${active}</p></div>
                       <div class="summary-card"><h3>Suspended</h3><p>${suspended}</p></div>
                       <div class="summary-card"><h3>Rejected</h3><p>${rejected}</p></div>`;
  container.innerHTML = summaryHtml;

  // Permit creation for issuer
  if(currentUser.role==='issuer'){
    const addPermitCard = document.createElement('div'); addPermitCard.className='card';
    addPermitCard.innerHTML=`<h3><i class="fas fa-plus-circle"></i> Create Permit</h3>
      <label>PTW Number</label><input type="text" id="ptwNumber">
      <label>Permit Type</label><select id="permitType">
        <option value="Cold Work">Cold Work</option>
        <option value="Hot Work">Hot Work</option>
        <option value="Electrical">Electrical</option>
        <option value="Confined Space">Confined Space</option>
      </select>
      <label>Work Location</label><input type="text" id="workLocation">
      <label>Date & Time</label><input type="datetime-local" id="workDateTime">
      <label>Permit Holder</label><input type="text" id="permitHolder">
      <label>Safety Contact</label><input type="text" id="safetyContactName">
      <label>Safety Number</label><input type="text" id="safetyContactNumber">
      <label>Work Description</label><textarea id="workDescription" rows="3"></textarea>
      <label>Reviewer</label><input type="text" id="reviewerName">
      <label>Issuer</label><input type="text" id="issuerName" value="${currentUser.username}">
      <label>Upload JSA / Documents</label><input type="file" id="permFiles" multiple>
      <label>Acknowledgment</label><select id="holderAcknowledgment">
        <option value="Pending">Pending</option>
        <option value="Accepted">Accepted</option>
        <option value="Suspended">Suspended</option>
      </select>
      <button onclick="addPermit()"><i class="fas fa-save"></i> Save Permit</button>`;
    container.appendChild(addPermitCard);
  }

  // Permit table
  const table = document.createElement('table');
  table.innerHTML=`<tr>
    <th>PTW #</th><th>Type</th><th>Location</th><th>Holder</th><th>Issuer</th><th>Status</th><th>Actions</th>
  </tr>`;
  permits.forEach(p=>{
    // Role-based filter
    if(currentUser.role==='issuer' && p.issuer!==currentUser.username) return;
    if(currentUser.role==='verifier' && p.status!=='Pending' && p.status!=='Approved') return;

    let actions='';
    if(currentUser.role==='issuer'){ actions=`<button onclick="editPermit(${p.id})"><i class="fas fa-edit"></i> Edit</button>`; }
    else if(currentUser.role==='verifier'){ actions=`<button onclick="approvePermit(${p.id})"><i class="fas fa-check"></i> Approve</button>
      <button onclick="rejectPermit(${p.id})"><i class="fas fa-times"></i> Reject</button>`; }
    else if(currentUser.role==='holder' && currentUser.username===p.holder){ actions=`<button onclick="updateAck(${p.id},'Accepted')"><i class="fas fa-check"></i> Accept</button>
      <button onclick="updateAck(${p.id},'Suspended')"><i class="fas fa-pause-circle"></i> Suspend</button>`; }

    const filesLinks = p.files ? p.files.map(f=>`<a href="${f.data}" download="${f.name}">${f.name}</a>`).join('<br>') : '';

    table.innerHTML+=`<tr>
      <td>${p.ptwNumber}</td>
      <td>${p.type}</td>
      <td>${p.location}</td>
      <td>${p.holder}</td>
      <td>${p.issuer}</td>
      <td><span class="badge badge-${p.status}">${p.status}</span></td>
      <td>${actions} <button onclick="downloadPDF(${p.id})"><i class="fas fa-download"></i> PDF</button><br>${filesLinks}</td>
    </tr>`;
  });
  container.appendChild(table);
}

// Permit actions
function addPermit(){
  const fileInput = document.getElementById('permFiles');
  const filesArr = [];
  if(fileInput.files.length>0){
    for(let f of fileInput.files){
      const reader = new FileReader();
      reader.onload = function(e){
        filesArr.push({name:f.name,data:e.target.result});
        if(filesArr.length===fileInput.files.length){
          savePermit(filesArr);
        }
      };
      reader.readAsDataURL(f);
    }
  } else savePermit([]);

  function savePermit(filesArr){
    const p={id:Date.now(),
      ptwNumber: document.getElementById('ptwNumber').value,
      type: document.getElementById('permitType').value,
      location: document.getElementById('workLocation').value,
      dateTime: document.getElementById('workDateTime').value,
      holder: document.getElementById('permitHolder').value,
      safetyName: document.getElementById('safetyContactName').value,
      safetyNumber: document.getElementById('safetyContactNumber').value,
      description: document.getElementById('workDescription').value,
      reviewer: document.getElementById('reviewerName').value,
      issuer: document.getElementById('issuerName').value,
      acknowledgment: document.getElementById('holderAcknowledgment').value,
      status:'Draft',
      files: filesArr};
    permits.push(p); localStorage.setItem('permits', JSON.stringify(permits));
    alert('Permit saved!'); showSection('permitManagement');
  }
}

function updateAck(id,value){ const p=permits.find(x=>x.id===id); if(p){p.acknowledgment=value; localStorage.setItem('permits', JSON.stringify(permits)); showSection('permitManagement'); } }
function approvePermit(id){ const p=permits.find(x=>x.id===id); if(p){p.status='Approved'; localStorage.setItem('permits', JSON.stringify(permits)); showSection('permitManagement'); } }
function rejectPermit(id){ const p=permits.find(x=>x.id===id); if(p){p.status='Rejected'; localStorage.setItem('permits', JSON.stringify(permits)); showSection('permitManagement'); } }
function editPermit(id){ const p=permits.find(x=>x.id===id); if(!p) return;
  const loc=prompt("Edit Work Location", p.location); if(loc) p.location=loc;
  const desc=prompt("Edit Work Description", p.description); if(desc) p.description=desc;
  localStorage.setItem('permits', JSON.stringify(permits)); showSection('permitManagement');
}

// PDF download
function downloadPDF(id){
  const { jsPDF } = window.jspdf; const p=permits.find(x=>x.id===id); if(!p) return;
  const doc=new jsPDF();
  doc.setFontSize(18); doc.text("EHS Permit-to-Work",105,20,null,null,"center");
  doc.setFontSize(12);
  doc.text(`PTW Number: ${p.ptwNumber}`,20,40);
  doc.text(`Permit Type: ${p.type}`,20,50);
  doc.text(`Work Location: ${p.location}`,20,60);
  doc.text(`Date & Time: ${p.dateTime}`,20,70);
  doc.text(`Permit Holder: ${p.holder}`,20,80);
  doc.text(`Safety Contact: ${p.safetyName} (${p.safetyNumber})`,20,90);
  doc.text("Work Description:",20,100);
  doc.text(doc.splitTextToSize(p.description,170),20,110);
  doc.text(`Reviewer: ${p.reviewer}`,20,150);
  doc.text(`Issuer: ${p.issuer}`,20,160);
  doc.text(`Acknowledgment: ${p.acknowledgment}`,20,170);
  doc.text(`Status: ${p.status}`,20,180);
  if(p.files && p.files.length>0){
    doc.text("Attached Files:",20,190);
    p.files.forEach((f,i)=>doc.text(`${i+1}. ${f.name}`,25,200+(i*10)));
  }
  doc.save(`Permit_${p.ptwNumber}_${new Date().toISOString().slice(0,10)}.pdf`);
}
</script>
</body>
</html>
