<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Audit Report Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f4f6f9;
    }
    h1 {
      text-align: center;
      color: #2E7D32;
    }
    form, table {
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      background: #2E7D32;
      color: white;
      cursor: pointer;
    }
    button:hover { background: #1b5e20; }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: center;
      vertical-align: middle;
    }
    th { background: #2E7D32; color: white; }
    .actions i {
      cursor: pointer;
      margin: 0 5px;
      font-size: 18px;
    }
    .actions .edit { color: #1976d2; }
    .actions .delete { color: #d32f2f; }
    #auditReport {
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    #visitorCount {
      text-align: center;
      margin-top: 20px;
      font-weight: bold;
    }
    footer {
      text-align: center;
      margin-top: 10px;
      font-size: 14px;
      color: gray;
    }
  </style>
</head>
<body>
  <h1>Audit Report Dashboard</h1>

  <form id="auditForm">
    <label>Audit Date:<input type="date" id="date" required></label>
    <label>Auditor:<input type="text" id="auditor" required></label>
    <label>Location:<input type="text" id="location" required></label>
    <label>Observation:<textarea id="observation" required></textarea></label>
    <label>Nature of Hazard:<input type="text" id="hazardNature" required></label>
    <label>Risk Category:
      <select id="category" required>
        <option>High Risk</option>
        <option>Medium Risk</option>
        <option>Low Risk</option>
        <option>Good Practice</option>
      </select>
    </label>
    <label>Recommended Action:<textarea id="recommendedAction" required></textarea></label>
    <label>Action Taken:<textarea id="actionTaken"></textarea></label>
    <label>Responsible Person:<input type="text" id="responsiblePerson" required></label>
    <label>Target Date:<input type="date" id="targetDate" required></label>
    <label>Status:
      <select id="status" required>
        <option>Open</option>
        <option>Closed</option>
        <option>In Progress</option>
      </select>
    </label>
    <label>Upload Photo:<input type="file" id="photo"></label>
    <button type="submit">Add Audit Record</button>
  </form>

  <div id="auditReport"></div>

  <canvas id="riskChart" height="100"></canvas>

  <table id="auditTable">
    <thead>
      <tr>
        <th>S.No</th>
        <th>Date</th>
        <th>Auditor</th>
        <th>Location</th>
        <th>Observation</th>
        <th>Hazard</th>
        <th>Risk</th>
        <th>Action</th>
        <th>Taken</th>
        <th>Responsible</th>
        <th>Target</th>
        <th>Status</th>
        <th>Photo</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button id="exportBtn">Export to Excel</button>

  <div id="visitorCount"></div>
  <footer>Developed by Arun Williams</footer>

  <script>
    let records = [];
    let editIndex = -1;

    document.getElementById("auditForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const record = {
        date: date.value,
        auditor: auditor.value,
        location: location.value,
        observation: observation.value,
        hazardNature: hazardNature.value,
        category: category.value,
        recommendedAction: recommendedAction.value,
        actionTaken: actionTaken.value,
        responsiblePerson: responsiblePerson.value,
        targetDate: targetDate.value,
        status: status.value,
        photo: ""
      };
      const file = document.getElementById("photo").files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          record.photo = event.target.result;
          saveRecord(record);
        };
        reader.readAsDataURL(file);
      } else { saveRecord(record); }
      this.reset();
    });

    function saveRecord(record) {
      if(editIndex === -1) records.push(record);
      else { records[editIndex] = record; editIndex = -1; }
      renderTable();
      updateReport();
    }

    function renderTable() {
      const tbody = document.querySelector("#auditTable tbody");
      tbody.innerHTML = "";
      records.forEach((r,i)=>{
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${i+1}</td><td>${r.date}</td><td>${r.auditor}</td>
          <td>${r.location}</td><td>${r.observation}</td><td>${r.hazardNature}</td>
          <td>${r.category}</td><td>${r.recommendedAction}</td><td>${r.actionTaken}</td>
          <td>${r.responsiblePerson}</td><td>${r.targetDate}</td><td>${r.status}</td>
          <td>${r.photo?`<img src="${r.photo}" width="50">`:""}</td>
          <td class="actions">
            <i class="fas fa-edit edit" onclick="editRecord(${i})"></i>
            <i class="fas fa-trash delete" onclick="deleteRecord(${i})"></i>
          </td>`;
        tbody.appendChild(row);
      });
    }

    function editRecord(i){
      const r = records[i]; editIndex = i;
      date.value=r.date; auditor.value=r.auditor; location.value=r.location;
      observation.value=r.observation; hazardNature.value=r.hazardNature;
      category.value=r.category; recommendedAction.value=r.recommendedAction;
      actionTaken.value=r.actionTaken; responsiblePerson.value=r.responsiblePerson;
      targetDate.value=r.targetDate; status.value=r.status;
    }

    function deleteRecord(i){ records.splice(i,1); renderTable(); updateReport(); }

    function updateReport() {
      const counts = { high:0, medium:0, low:0, good:0 };
      records.forEach(r=>{
        if(r.category==="High Risk") counts.high++;
        else if(r.category==="Medium Risk") counts.medium++;
        else if(r.category==="Low Risk") counts.low++;
        else if(r.category==="Good Practice") counts.good++;
      });
      document.getElementById("auditReport").innerHTML =
        `<p>ðŸ”´ High Risk: ${counts.high}</p>
         <p>ðŸŸ  Medium Risk: ${counts.medium}</p>
         <p>ðŸŸ¢ Low Risk: ${counts.low}</p>
         <p>âœ… Good Practice: ${counts.good}</p>`;
      renderChart(counts);
    }

    function renderChart(counts) {
      const ctx=document.getElementById("riskChart").getContext("2d");
      if(window.riskChart) window.riskChart.destroy();
      window.riskChart=new Chart(ctx,{
        type:"pie",
        data:{labels:["High","Medium","Low","Good"],
          datasets:[{data:[counts.high,counts.medium,counts.low,counts.good]}]}
      });
    }

    // Export to Excel with centered photos
    document.getElementById("exportBtn").addEventListener("click", async function () {
      const wb = new ExcelJS.Workbook();
      const ws = wb.addWorksheet("Audit Report");

      ws.mergeCells("A1:M1");
      ws.getCell("A1").value = "Project Name: XYZ Project";
      ws.getCell("A1").alignment = { horizontal: "center", vertical: "middle" };
      ws.getCell("A1").font = { bold: true, size: 14 };

      ws.mergeCells("A2:M2");
      ws.getCell("A2").value = "Audit No: 001";
      ws.getCell("A2").alignment = { horizontal: "center", vertical: "middle" };
      ws.getCell("A2").font = { bold: true, size: 12 };

      ws.addRow([]);

      const header=["S.No","Audit Date","Auditor","Location","Observation",
        "Nature of Hazard","Risk Category","Recommended Action","Action Taken",
        "Responsible Person","Target Date","Status","Photo"];
      const headerRow=ws.addRow(header);
      headerRow.eachCell(c=>{
        c.font={bold:true,color:{argb:"FFFFFFFF"}};
        c.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF2E7D32"}};
        c.alignment={horizontal:"center",vertical:"middle",wrapText:true};
      });

      ws.columns=[
        {width:6},{width:12},{width:15},{width:15},{width:25},
        {width:20},{width:15},{width:25},{width:25},{width:15},
        {width:12},{width:10},{width:15}
      ];

      for(let i=0;i<records.length;i++){
        const r=records[i];
        const row=ws.addRow([
          i+1,r.date,r.auditor,r.location,r.observation,r.hazardNature,
          r.category,r.recommendedAction,r.actionTaken,
          r.responsiblePerson,r.targetDate,r.status,""
        ]);
        row.height=55;

        row.eachCell((cell,col)=>{
          if(col===7){
            let fillColor="";
            switch(r.category){
              case "High Risk": fillColor="FFCDD2"; break;
              case "Medium Risk": fillColor="FFF9C4"; break;
              case "Low Risk": fillColor="C8E6C9"; break;
              case "Good Practice": fillColor="E8F5E9"; break;
            }
            cell.fill={type:"pattern",pattern:"solid",fgColor:{argb:fillColor}};
          }
          cell.alignment={horizontal:"center",vertical:"middle",wrapText:true};
        });

        if(r.photo){
          const imageId=wb.addImage({base64:r.photo,extension:"png"});
          ws.addImage(imageId,{
            tl:{col:12.2,row:row.number-0.8},
            ext:{width:45,height:45},
            editAs:"oneCell"
          });
          ws.getCell("M"+row.number).alignment={horizontal:"center",vertical:"middle"};
        }
      }

      wb.xlsx.writeBuffer().then(data=>{
        const blob=new Blob([data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});
        saveAs(blob,"Audit_Report.xlsx");
      });
    });

    // Visitor counter using CountAPI
    fetch("https://api.countapi.xyz/hit/audit-dashboard/visits")
      .then(res=>res.json())
      .then(data=>{
        document.getElementById("visitorCount").innerText = "Visitor Count: " + data.value;
      });
  </script>
</body>
</html>
