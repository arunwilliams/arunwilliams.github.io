<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EHS Audit Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://kit.fontawesome.com/a2d04d4a05.js" crossorigin="anonymous"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f6f7;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: auto;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .card h2 {
      color: #2e7d32;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #2e7d32;
      color: white;
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 15px;
    }
    button:hover {
      background-color: #256528;
    }
    .table-container {
      max-height: 500px;
      overflow-y: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      text-align: center;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    th {
      background-color: #2e7d32;
      color: white;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    /* Risk-based highlighting */
    .high-risk { background-color: #f8d7da; border-left: 6px solid red; }
    .medium-risk { background-color: #fff3cd; border-left: 6px solid orange; }
    .low-risk { background-color: #d4edda; border-left: 6px solid green; }
    .good-practice { background-color: #e8f5e9; border-left: 6px solid #2e7d32; }
  </style>
</head>
<body>
  <div class="container">

    <!-- Audit Form -->
    <div class="card">
      <h2><i class="fas fa-hard-hat"></i> Audit Form</h2>
      <form id="auditForm">
        <label>Audit Date</label>
        <input type="date" id="auditDate" required>

        <label>Auditor Name</label>
        <input type="text" id="auditorName" required>

        <label>Location / Site</label>
        <input type="text" id="location" required>

        <label>Observation</label>
        <textarea id="observation" required></textarea>

        <label>Nature of the Hazard</label>
        <input type="text" id="hazardNature">

        <label>Category</label>
        <select id="category" required>
          <option value="High Risk">High Risk</option>
          <option value="Medium Risk">Medium Risk</option>
          <option value="Low Risk">Low Risk</option>
          <option value="Good Practice">Good Practice</option>
        </select>

        <label>Corrective Action Required</label>
        <textarea id="correctiveAction"></textarea>

        <label>Recommended Action</label>
        <textarea id="recommendedAction"></textarea>

        <label>Responsible Person</label>
        <input type="text" id="responsiblePerson">

        <label>Target Date</label>
        <input type="date" id="targetDate">

        <label>Status</label>
        <select id="status">
          <option value="Open">Open</option>
          <option value="Closed">Closed</option>
        </select>

        <label>Attach Photo</label>
        <input type="file" id="photo" accept="image/*" capture="environment">

        <button type="submit">Add Record</button>
      </form>
    </div>

    <!-- Audit Records -->
    <div class="card">
      <h2><i class="fas fa-table"></i> Audit Records</h2>
      <div class="table-container">
        <table id="auditTable">
          <thead>
            <tr>
              <th>S.No</th>
              <th>Audit Date</th>
              <th>Auditor Name</th>
              <th>Location / Site</th>
              <th>Observation</th>
              <th>Nature of the Hazard</th>
              <th>Category</th>
              <th>Corrective Action Required</th>
              <th>Recommended Action</th>
              <th>Responsible Person</th>
              <th>Target Date</th>
              <th>Status</th>
              <th>Photo</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <button id="downloadBtn"><i class="fas fa-file-excel"></i> Export to Excel</button>
    </div>

  </div>

  <script>
    let records = [];
    let serial = 1;

    document.getElementById("auditForm").addEventListener("submit", function(e) {
      e.preventDefault();

      const reader = new FileReader();
      const file = document.getElementById("photo").files[0];

      if (file) {
        reader.readAsDataURL(file);
      }

      reader.onloadend = () => {
        const record = {
          sno: serial++,
          auditDate: document.getElementById("auditDate").value,
          auditorName: document.getElementById("auditorName").value,
          location: document.getElementById("location").value,
          observation: document.getElementById("observation").value,
          hazardNature: document.getElementById("hazardNature").value,
          category: document.getElementById("category").value,
          correctiveAction: document.getElementById("correctiveAction").value,
          recommendedAction: document.getElementById("recommendedAction").value,
          responsiblePerson: document.getElementById("responsiblePerson").value,
          targetDate: document.getElementById("targetDate").value,
          status: document.getElementById("status").value,
          photo: file ? reader.result : ""
        };

        records.push(record);
        appendRecord(record);
        document.getElementById("auditForm").reset();
      };

      if (!file) reader.onloadend();
    });

    function appendRecord(record) {
      const tbody = document.querySelector("#auditTable tbody");
      const tr = document.createElement("tr");

      // Risk highlighting
      if (record.category === "High Risk") tr.classList.add("high-risk");
      if (record.category === "Medium Risk") tr.classList.add("medium-risk");
      if (record.category === "Low Risk") tr.classList.add("low-risk");
      if (record.category === "Good Practice") tr.classList.add("good-practice");

      tr.innerHTML = `
        <td>${record.sno}</td>
        <td>${record.auditDate}</td>
        <td>${record.auditorName}</td>
        <td>${record.location}</td>
        <td>${record.observation}</td>
        <td>${record.hazardNature}</td>
        <td>${record.category}</td>
        <td>${record.correctiveAction}</td>
        <td>${record.recommendedAction}</td>
        <td>${record.responsiblePerson}</td>
        <td>${record.targetDate}</td>
        <td>${record.status}</td>
        <td>${record.photo ? `<img src="${record.photo}" width="60">` : ""}</td>
      `;
      tbody.appendChild(tr);
    }

    document.getElementById("downloadBtn").addEventListener("click", function() {
      const ws_data = [
        ["Project Name: __________", "Audit No: __________"],
        [],
        ["S.No","Audit Date","Auditor Name","Location / Site","Observation","Nature of the Hazard",
         "Category","Corrective Action Required","Recommended Action","Responsible Person",
         "Target Date","Status","Photo"]
      ];

      records.forEach(r => {
        ws_data.push([
          r.sno, r.auditDate, r.auditorName, r.location, r.observation, r.hazardNature,
          r.category, r.correctiveAction, r.recommendedAction, r.responsiblePerson,
          r.targetDate, r.status, r.photo ? "[Photo Attached]" : ""
        ]);
      });

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(ws_data);

      ws["!merges"] = [{ s: {r:0,c:0}, e: {r:0,c:11} }];
      ws["!cols"] = Array(12).fill({ wch: 20 });

      XLSX.utils.book_append_sheet(wb, ws, "Audit Data");
      XLSX.writeFile(wb, "Audit_Data.xlsx");
    });
  </script>
</body>
</html>
