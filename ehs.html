<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HSE Audit Data Collection</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f4f9f4;
      color: #333;
    }

    h1 {
      text-align: center;
      color: #2e7d32;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    form label {
      font-weight: bold;
      color: #2e7d32;
    }

    form input, form select, form textarea {
      width: 100%;
      padding: 8px;
      margin: 6px 0 15px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    form button {
      background: #2e7d32;
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    form button:hover {
      background: #256327;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    table, th, td {
      border: 1px solid #ddd;
    }

    th {
      background: #2e7d32;
      color: #fff;
      padding: 10px;
      text-align: center;
    }

    td {
      padding: 8px;
      text-align: center;
      vertical-align: middle;
    }

    td img {
      max-width: 80px;
      max-height: 60px;
      border-radius: 4px;
    }

    .risk-high { background-color: #f28b82; font-weight: bold; }
    .risk-medium { background-color: #fff475; font-weight: bold; }
    .risk-low { background-color: #81c995; font-weight: bold; }
    .good-practice { background-color: #b2f2bb; font-weight: bold; }

    #downloadBtn {
      background: #2e7d32;
      color: white;
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      display: block;
      margin: 15px auto;
      box-shadow: 0px 4px 8px rgba(0,0,0,0.2);
    }

    #downloadBtn i { margin-right: 6px; }
    #downloadBtn:hover { background: #256327; }
  </style>
</head>
<body>

  <h1><i class="fas fa-helmet-safety"></i> HSE Audit Data Collection</h1>

  <!-- Form Card -->
  <div class="card">
    <form id="auditForm">
      <label>Date:</label>
      <input type="date" name="date" required>

      <label>Auditor:</label>
      <input type="text" name="auditor" required>

      <label>Location:</label>
      <input type="text" name="location" required>

      <label>Observation:</label>
      <textarea name="observation" required></textarea>

      <label>Nature of Hazard:</label>
      <input type="text" name="hazard" required>

      <label>Category:</label>
      <select name="category" required>
        <option value="High Risk">ðŸ”´ High Risk</option>
        <option value="Medium Risk">ðŸŸ¡ Medium Risk</option>
        <option value="Low Risk">ðŸŸ¢ Low Risk</option>
        <option value="Good Practice">âœ… Good Practice</option>
      </select>

      <label>Recommended Action:</label>
      <textarea name="action" required></textarea>

      <label>Responsible Person:</label>
      <input type="text" name="responsible" required>

      <label>Target Date:</label>
      <input type="date" name="target" required>

      <label>Status:</label>
      <select name="status" required>
        <option value="Open">Open</option>
        <option value="In Progress">In Progress</option>
        <option value="Closed">Closed</option>
      </select>

      <label>Upload Photo:</label>
      <input type="file" name="photo" accept="image/*" capture="environment">

      <button type="submit"><i class="fas fa-plus-circle"></i> Add Record</button>
    </form>
  </div>

  <!-- Records Card -->
  <div class="card">
    <h2><i class="fas fa-table"></i> Audit Records</h2>
    <table>
      <thead>
        <tr>
          <th>S. No.</th>
          <th>Date</th>
          <th>Auditor</th>
          <th>Location</th>
          <th>Observation</th>
          <th>Nature of Hazard</th>
          <th>Category</th>
          <th>Recommended Action</th>
          <th>Responsible</th>
          <th>Target</th>
          <th>Status</th>
          <th>Photo</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <button id="downloadBtn"><i class="fas fa-file-excel"></i> Export to Excel</button>

  <script>
    const form = document.getElementById("auditForm");
    const tableBody = document.getElementById("tableBody");
    const downloadBtn = document.getElementById("downloadBtn");
    let records = [];

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(",")[1]);
        reader.onerror = error => reject(error);
      });
    }

    form.addEventListener("submit", async function(e) {
      e.preventDefault();
      const formData = new FormData(form);
      const row = [];

      row.push(records.length + 1); // S. No.
      formData.forEach((value, key) => { if (key !== "photo") row.push(value); });

      const file = formData.get("photo");
      let base64Img = "";
      let imgUrl = "";
      if (file && file.size > 0) {
        base64Img = await fileToBase64(file);
        imgUrl = URL.createObjectURL(file);
        row.push({ preview: imgUrl, base64: base64Img, mime: file.type });
      } else row.push(null);

      records.push(row);

      const tr = document.createElement("tr");
      row.forEach((cell, index) => {
        const td = document.createElement("td");

        if (index === 6) { // Category
          td.textContent = cell;
          if (cell.includes("High Risk")) td.classList.add("risk-high");
          if (cell.includes("Medium Risk")) td.classList.add("risk-medium");
          if (cell.includes("Low Risk")) td.classList.add("risk-low");
          if (cell.includes("Good Practice")) td.classList.add("good-practice");
        } else if (index === 11 && cell) {
          const img = document.createElement("img");
          img.src = cell.preview;
          td.appendChild(img);
        } else {
          td.textContent = typeof cell === "string" || typeof cell === "number" ? cell : "";
        }

        tr.appendChild(td);
      });
      tableBody.appendChild(tr);

      form.reset();
    });

    downloadBtn.addEventListener("click", async function () {
      const workbook = new ExcelJS.Workbook();
      const sheet = workbook.addWorksheet("Audit Records");

      // Project Title
      sheet.mergeCells("A1:L1");
      sheet.getCell("A1").value = "Project: Safety Improvement | Audit No: 001";
      sheet.getCell("A1").alignment = { horizontal: "center" };
      sheet.getCell("A1").font = { bold: true, size: 14, color: { argb: "FFFFFFFF" } };
      sheet.getCell("A1").fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FF2E7D32" } };

      // Header
      const header = ["S. No.", "Date", "Auditor", "Location", "Observation", "Nature of Hazard", "Category", "Recommended Action", "Responsible", "Target", "Status", "Photo"];
      sheet.addRow(header);
      sheet.getRow(2).font = { bold: true, color: { argb: "FFFFFFFF" } };
      sheet.getRow(2).fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FF2E7D32" } };

      // Data rows
      records.forEach((r, rowIndex) => {
        const excelRow = sheet.addRow(r.map((v, i) => (i === 11 ? "" : v)));

        const categoryCell = excelRow.getCell(7);
        if (r[6].includes("High Risk")) {
          categoryCell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFFF0000" } };
        } else if (r[6].includes("Medium Risk")) {
          categoryCell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFFFFF00" } };
        } else if (r[6].includes("Low Risk")) {
          categoryCell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FF00FF00" } };
        } else if (r[6].includes("Good Practice")) {
          categoryCell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFB2F2BB" } };
        }

        if (r[11]) {
          const imageId = workbook.addImage({
            base64: `data:${r[11].mime};base64,${r[11].base64}`,
            extension: r[11].mime.split("/")[1],
          });
          sheet.addImage(imageId, {
            tl: { col: 11, row: rowIndex + 2 },
            ext: { width: 100, height: 70 },
          });
          sheet.getRow(rowIndex + 3).height = 55;
        }
      });

      sheet.columns = [
        { width: 8 }, { width: 12 }, { width: 18 }, { width: 18 },
        { width: 30 }, { width: 22 }, { width: 18 }, { width: 25 },
        { width: 20 }, { width: 12 }, { width: 12 }, { width: 15 }
      ];

      const buffer = await workbook.xlsx.writeBuffer();
      saveAs(new Blob([buffer]), "audit_records.xlsx");
    });
  </script>
</body>
</html>
