<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EHS Audit Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    .high { background-color: #ffcdd2; }
    .medium { background-color: #fff9c4; }
    .low { background-color: #c8e6c9; }
    .good { background-color: #e8f5e9; }
    #summary { margin-top: 20px; font-weight: bold; }
    #footer { margin-top: 40px; text-align: center; font-size: 14px; color: gray; }
    button { margin: 5px; padding: 6px 12px; }
  </style>
</head>
<body>
  <h1>EHS Audit Dashboard</h1>

  <!-- Audit Form -->
  <form id="auditForm">
    <label>Date: <input type="date" id="date" required></label>
    <label>Auditor: <input type="text" id="auditor" required></label>
    <label>Project: <input type="text" id="project" required></label>
    <label>Location: <input type="text" id="location" required></label>
    <label>Observation: <input type="text" id="observation" required></label>
    <label>Risk Level:
      <select id="risk" required>
        <option value="High Risk">High Risk</option>
        <option value="Medium Risk">Medium Risk</option>
        <option value="Low Risk">Low Risk</option>
        <option value="Good Practice">Good Practice</option>
      </select>
    </label>
    <label>Upload Photo: <input type="file" id="photo" accept="image/*"></label>
    <button type="submit">Add Record</button>
  </form>

  <!-- Audit Records -->
  <table id="auditTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Auditor</th>
        <th>Project</th>
        <th>Location</th>
        <th>Observation</th>
        <th>Risk</th>
        <th>Photo</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Summary -->
  <div id="summary">Summary: High Risk=0, Medium Risk=0, Low Risk=0, Good Practice=0</div>

  <!-- Export -->
  <button id="exportExcel">Export to Excel</button>

  <!-- Footer -->
  <div id="footer">
    <span id="visitorCount">Visitors: 0</span> | Developed by Arun Williams
  </div>

<script>
let records = [];
let editIndex = null;

// Handle form submit
document.getElementById("auditForm").addEventListener("submit", function(e) {
  e.preventDefault();

  const date = document.getElementById("date").value;
  const auditor = document.getElementById("auditor").value;
  const project = document.getElementById("project").value;
  const location = document.getElementById("location").value;
  const observation = document.getElementById("observation").value;
  const risk = document.getElementById("risk").value;
  const photoInput = document.getElementById("photo");

  if (photoInput.files.length > 0) {
    const reader = new FileReader();
    reader.onload = function(e) {
      saveRecord(date, auditor, project, location, observation, risk, e.target.result);
    };
    reader.readAsDataURL(photoInput.files[0]);
  } else {
    saveRecord(date, auditor, project, location, observation, risk, null);
  }

  this.reset();
});

// Save or update record
function saveRecord(date, auditor, project, location, observation, risk, photo) {
  const record = { date, auditor, project, location, observation, risk, photo };

  if (editIndex !== null) {
    records[editIndex] = record;
    editIndex = null;
  } else {
    records.push(record);
  }

  renderTable();
  updateSummary();
}

// Render table
function renderTable() {
  const tbody = document.querySelector("#auditTable tbody");
  tbody.innerHTML = "";
  records.forEach((r, i) => {
    const row = tbody.insertRow();
    row.insertCell(0).textContent = r.date;
    row.insertCell(1).textContent = r.auditor;
    row.insertCell(2).textContent = r.project;
    row.insertCell(3).textContent = r.location;
    row.insertCell(4).textContent = r.observation;

    const riskCell = row.insertCell(5);
    riskCell.textContent = r.risk;
    if (r.risk === "High Risk") riskCell.className = "high";
    else if (r.risk === "Medium Risk") riskCell.className = "medium";
    else if (r.risk === "Low Risk") riskCell.className = "low";
    else riskCell.className = "good";

    const photoCell = row.insertCell(6);
    if (r.photo) {
      const img = document.createElement("img");
      img.src = r.photo;
      img.width = 50;
      photoCell.appendChild(img);
    } else {
      photoCell.textContent = "No Photo";
    }

    const actionCell = row.insertCell(7);
    const editBtn = document.createElement("button");
    editBtn.textContent = "Edit";
    editBtn.onclick = () => editRecord(i);
    actionCell.appendChild(editBtn);
  });
}

// Edit record
function editRecord(index) {
  const r = records[index];
  document.getElementById("date").value = r.date;
  document.getElementById("auditor").value = r.auditor;
  document.getElementById("project").value = r.project;
  document.getElementById("location").value = r.location;
  document.getElementById("observation").value = r.observation;
  document.getElementById("risk").value = r.risk;
  editIndex = index;
}

// Update summary
function updateSummary() {
  let high = 0, medium = 0, low = 0, good = 0;
  records.forEach(r => {
    if (r.risk === "High Risk") high++;
    else if (r.risk === "Medium Risk") medium++;
    else if (r.risk === "Low Risk") low++;
    else good++;
  });
  document.getElementById("summary").textContent =
    `Summary: High Risk=${high}, Medium Risk=${medium}, Low Risk=${low}, Good Practice=${good}`;
}

// Export Excel
document.getElementById("exportExcel").addEventListener("click", function() {
  const wb = XLSX.utils.book_new();
  const ws_data = [
    ["Date","Auditor","Project","Location","Observation","Risk Level"]
  ];
  records.forEach(r => {
    ws_data.push([r.date, r.auditor, r.project, r.location, r.observation, r.risk]);
  });
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, "Audit Report");
  XLSX.writeFile(wb, "Audit_Report.xlsx");
});

// Visitor Count (Live with CountAPI)
const namespace = "ehs_dashboard_arun";
const key = "visitor_count";

function fetchVisitorCount() {
  fetch(`https://api.countapi.xyz/get/${namespace}/${key}`)
    .then(res => res.json())
    .then(data => {
      document.getElementById("visitorCount").textContent = "Visitors: " + data.value;
    });
}

function incrementVisitorCount() {
  fetch(`https://api.countapi.xyz/hit/${namespace}/${key}`)
    .then(res => res.json())
    .then(data => {
      document.getElementById("visitorCount").textContent = "Visitors: " + data.value;
    });
}

// Increment on page load
incrementVisitorCount();
// Refresh count every 10 seconds
setInterval(fetchVisitorCount, 10000);
</script>
</body>
</html>
