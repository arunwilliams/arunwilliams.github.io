<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EHS Audit Tool</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver/dist/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<style>
body { font-family: Arial, sans-serif; background:#f0f2f5; margin:0; padding:20px; }
.container { max-width:1200px; margin:auto; }
.card { background:#fff; border-radius:10px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:20px; }
.card h2 { color:#2e7d32; text-align:center; }
form .row { display:flex; flex-wrap:wrap; margin-bottom:10px; align-items:center; }
form .row label { flex:1 0 150px; font-weight:bold; }
form .row input, form .row select, form .row textarea { flex:2 0 300px; padding:5px; }
table { width:100%; border-collapse: collapse; margin-top:10px; }
table th, table td { border:1px solid #ccc; padding:8px; text-align:center; vertical-align:middle; word-break:break-word; }
table th { background:#2e7d32; color:#fff; }
.high-risk { background:#f8d7da; border:1px solid #f5c6cb; }
.medium-risk { background:#fff3cd; border:1px solid #ffeeba; }
.low-risk { background:#d4edda; border:1px solid #c3e6cb; }
.good-practice { background:#e8f5e9; border:1px solid #2e7d32; }
@media(max-width:768px){
  form .row { flex-direction:column; align-items:flex-start; }
  form .row label, form .row input, form .row select, form .row textarea { flex:1 0 100%; }
}
button { background:#2e7d32; color:#fff; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; margin-top:10px; }
button:hover { background:#1b5e20; }
</style>
</head>
<body>
<div class="container">
  <!-- Audit Form -->
  <div class="card">
    <h2><i class="fas fa-hard-hat"></i> Audit Form</h2>
    <form id="auditForm">
      <div class="row"><label>Audit Date:</label><input type="date" id="auditDate" required></div>
      <div class="row"><label>Auditor Name:</label><input type="text" id="auditorName" required></div>
      <div class="row"><label>Location/Site:</label><input type="text" id="location" required></div>
      <div class="row"><label>Observation:</label><textarea id="observation" required></textarea></div>
      <div class="row"><label>Nature of Hazard:</label><input type="text" id="hazardNature"></div>
      <div class="row"><label>Risk Category:</label>
        <select id="category" required>
          <option value="High Risk">High Risk</option>
          <option value="Medium Risk">Medium Risk</option>
          <option value="Low Risk">Low Risk</option>
          <option value="Good Practice">Good Practice</option>
        </select>
      </div>
      <div class="row"><label>Recommended Action:</label><textarea id="recommendedAction"></textarea></div>
      <div class="row"><label>Action Taken:</label><textarea id="actionTaken"></textarea></div>
      <div class="row"><label>Responsible Person:</label><input type="text" id="responsiblePerson"></div>
      <div class="row"><label>Target Date:</label><input type="date" id="targetDate"></div>
      <div class="row"><label>Status:</label>
        <select id="status">
          <option value="Open">Open</option>
          <option value="Closed">Closed</option>
        </select>
      </div>
      <div class="row"><label>Photo:</label><input type="file" id="photo"></div>
      <button type="submit">Add Record</button>
    </form>
  </div>

  <!-- Audit Records -->
  <div class="card">
    <h2><i class="fas fa-table"></i> Audit Records</h2>
    <button id="exportBtn"><i class="fas fa-file-excel"></i> Export to Excel</button>
    <table id="recordsTable">
      <thead>
        <tr>
          <th>S.No</th><th>Audit Date</th><th>Auditor</th><th>Location</th><th>Observation</th>
          <th>Nature of Hazard</th><th>Risk Category</th><th>Recommended Action</th><th>Action Taken</th>
          <th>Responsible Person</th><th>Target Date</th><th>Status</th><th>Photo</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<canvas id="chartCanvas" width="400" height="150" style="display:none;"></canvas>

<script>
let records=[];
let persistentDate="", persistentAuditor="", persistentLocation="";

document.getElementById("auditForm").addEventListener("submit", function(e){
  e.preventDefault();
  const date=document.getElementById("auditDate").value;
  const auditor=document.getElementById("auditorName").value;
  const location=document.getElementById("location").value;
  const observation=document.getElementById("observation").value;
  const hazardNature=document.getElementById("hazardNature").value;
  const category=document.getElementById("category").value;
  const recommendedAction=document.getElementById("recommendedAction").value;
  const actionTaken=document.getElementById("actionTaken").value;
  const responsiblePerson=document.getElementById("responsiblePerson").value;
  const targetDate=document.getElementById("targetDate").value;
  const status=document.getElementById("status").value;
  const photoInput=document.getElementById("photo");
  const file=photoInput.files[0];

  const reader=new FileReader();
  reader.onload=function(e){
    const photoData=e.target.result;
    records.push({date,auditor,location,observation,hazardNature,category,recommendedAction,actionTaken,responsiblePerson,targetDate,status,photo:photoData});
    updateTable();
    persistentDate=date; persistentAuditor=auditor; persistentLocation=location;
  };
  if(file) reader.readAsDataURL(file);
  else { records.push({date,auditor,location,observation,hazardNature,category,recommendedAction,actionTaken,responsiblePerson,targetDate,status,photo:null}); updateTable(); persistentDate=date; persistentAuditor=auditor; persistentLocation=location;}
});

function updateTable(){
  const tbody=document.querySelector("#recordsTable tbody");
  tbody.innerHTML="";
  records.forEach((r,i)=>{
    const tr=document.createElement("tr");
    const riskClass=r.category==="High Risk"?"high-risk":r.category==="Medium Risk"?"medium-risk":r.category==="Low Risk"?"low-risk":"good-practice";
    tr.className=riskClass;
    tr.innerHTML=`<td>${i+1}</td><td>${r.date}</td><td>${r.auditor}</td><td>${r.location}</td><td>${r.observation}</td><td>${r.hazardNature}</td><td>${r.category}</td><td>${r.recommendedAction}</td><td>${r.actionTaken}</td><td>${r.responsiblePerson}</td><td>${r.targetDate}</td><td>${r.status}</td><td>${r.photo?`<img src="${r.photo}" width="50">`:''}</td>`;
    tbody.appendChild(tr);
  });
}

document.getElementById("exportBtn").addEventListener("click", async function(){
  const wb=new ExcelJS.Workbook();
  const ws=wb.addWorksheet("Audit Dashboard");

  ws.mergeCells("A1:M1"); ws.getCell("A1").value="Project Name: XYZ Project"; ws.getCell("A1").alignment={horizontal:"center"}; ws.getCell("A1").font={bold:true,size:14};
  ws.mergeCells("A2:M2"); ws.getCell("A2").value="Project Location: ABC Site"; ws.getCell("A2").alignment={horizontal:"center"}; ws.getCell("A2").font={bold:true,size:12};
  ws.mergeCells("A3:M3"); ws.getCell("A3").value=`Audit No:001 | Audit Date: ${persistentDate} | Auditor: ${persistentAuditor}`; ws.getCell("A3").alignment={horizontal:"center"}; ws.getCell("A3").font={bold:true,size:12};

  ws.addRow([]);

  const counts={"High Risk":0,"Medium Risk":0,"Low Risk":0,"Good Practice":0};
  records.forEach(r=>{if(counts[r.category]!==undefined) counts[r.category]++;});
  const totalObs=Object.values(counts).reduce((a,b)=>a+b,1);

  const ctx=document.getElementById('chartCanvas').getContext('2d');
  const chart=new Chart(ctx,{type:'bar',data:{labels:["High Risk","Medium Risk","Low Risk","Good Practice"],datasets:[{label:'Observations',data:[counts["High Risk"], counts["Medium Risk"], counts["Low Risk"], counts["Good Practice"]],backgroundColor:['#EF9A9A','#FFF59D','#A5D6A7','#81C784']}]},options:{responsive:false,plugins:{legend:{display:false},datalabels:{anchor:'end',align:'end',formatter:(v)=>`${((v/totalObs)*100).toFixed(1)}%`,color:'#000',font:{weight:'bold'}}},scales:{y:{beginAtZero:true}}},plugins:[ChartDataLabels]});
  const chartBase64=document.getElementById('chartCanvas').toDataURL().replace(/^data:image\/png;base64,/,"");
  const imageId=wb.addImage({base64:chartBase64,extension:'png'});
  ws.addImage(imageId,{tl:{col:0,row:4},ext:{width:700,height:200}});

  ws.addRow([]); ws.addRow([]);

  const header=["S.No","Audit Date","Auditor","Location","Observation","Nature of Hazard","Risk Category","Recommended Action","Action Taken","Responsible Person","Target Date","Status","Photo"];
  const headerRow=ws.addRow(header);
  headerRow.eachCell(cell=>{cell.font={bold:true,color:{argb:"FFFFFFFF"}};cell.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF2E7D32"}};cell.alignment={horizontal:"center",vertical:"middle",wrapText:true};cell.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"}};});
  ws.columns=[{width:6},{width:12},{width:15},{width:15},{width:25},{width:20},{width:15},{width:25},{width:25},{width:15},{width:12},{width:10},{width:15}];

  const riskColors={"High Risk":"FFEF9A9A","Medium Risk":"FFFFF59D","Low Risk":"FFA5D6A7","Good Practice":"FF81C784"};
  records.forEach((r,i)=>{
    const row=ws.addRow([i+1,r.date,r.auditor,r.location,r.observation,r.hazardNature,r.category,r.recommendedAction,r.actionTaken,r.responsiblePerson,r.targetDate,r.status,""]);
    row.height=50;
    row.eachCell((cell,col)=>{
      if(col===7){cell.fill={type:"pattern",pattern:"solid",fgColor:{argb:riskColors[r.category]}};}
      cell.alignment={horizontal:"center",vertical:"middle",wrapText:true};
      cell.border={top:{style:"thin"},left:{style:"thin"},bottom:{style:"thin"},right:{style:"thin"};};
    });
    if(r.photo){const imgId=wb.addImage({base64:r.photo,extension:'png'});ws.addImage(imgId,{tl:{col:12,row:row.number-1},ext:{width:50,height:50}});}
  });

  wb.xlsx.writeBuffer().then(data=>{const blob=new Blob([data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}); saveAs(blob,"Audit_Dashboard.xlsx");});
});
</script>
</body>
</html>
