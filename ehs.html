<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Audit Data Collection</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    form { max-width: 600px; margin: auto; }
    label { display: block; margin-top: 10px; }
    input, select, textarea { width: 100%; padding: 8px; margin-top: 5px; }
    button { margin-top: 20px; padding: 10px; width: 100%; background: #007BFF; color: white; border: none; cursor: pointer; }
    button:hover { background: #0056b3; }
    table { margin-top: 40px; width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; }
    th { background: #f2f2f2; }
    img { max-width: 100px; max-height: 100px; }
  </style>
</head>
<body>
  <h2>Audit Data Collection Form</h2>
  <form id="auditForm">
    <label>Audit Date:<input type="date" name="date" required></label>
    <label>Auditor Name:<input type="text" name="auditor" required></label>
    <label>Location:<input type="text" name="location" required></label>
    <label>Observation:<textarea name="observation" required></textarea></label>
    <label>Category:
      <select name="category" required>
        <option value="High Risk">High Risk</option>
        <option value="Medium Risk">Medium Risk</option>
        <option value="Low Risk">Low Risk</option>
        <option value="Good Practice">Good Practice</option>
      </select>
    </label>
    <label>Corrective Action:<textarea name="action"></textarea></label>
    <label>Responsible Person:<input type="text" name="responsible"></label>
    <label>Target Date:<input type="date" name="target"></label>
    <label>Status:
      <select name="status">
        <option value="Open">Open</option>
        <option value="Closed">Closed</option>
      </select>
    </label>
    <label>Photo:
      <input type="file" name="photo" accept="image/*" capture="environment">
    </label>
    <button type="submit">Add Entry</button>
  </form>

  <h2>Audit Records</h2>
  <table id="auditTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Auditor</th>
        <th>Location</th>
        <th>Observation</th>
        <th>Category</th>
        <th>Action</th>
        <th>Responsible</th>
        <th>Target</th>
        <th>Status</th>
        <th>Photo</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button id="downloadBtn">Download as CSV</button>

  <script>
    const form = document.getElementById("auditForm");
    const tableBody = document.getElementById("auditTable").querySelector("tbody");
    const downloadBtn = document.getElementById("downloadBtn");
    let records = [];

    form.addEventListener("submit", function(e) {
      e.preventDefault();
      const formData = new FormData(form);
      const row = [];

      formData.forEach((value, key) => {
        if (key !== "photo") row.push(value);
      });

      const file = formData.get("photo");
      let imgUrl = "";
      if (file && file.size > 0) {
        imgUrl = URL.createObjectURL(file);
        row.push(imgUrl);
      } else {
        row.push("");
      }
      records.push(row);

      // Add row to table
      const tr = document.createElement("tr");
      row.forEach((cell, index) => {
        const td = document.createElement("td");
        if (index === 9 && cell) { // photo column
          const img = document.createElement("img");
          img.src = cell;
          td.appendChild(img);
        } else {
          td.textContent = cell;
        }
        tr.appendChild(td);
      });
      tableBody.appendChild(tr);

      form.reset();
    });

    downloadBtn.addEventListener("click", function() {
      let csvContent = "data:text/csv;charset=utf-8,"
        + ["Date,Auditor,Location,Observation,Category,Action,Responsible,Target,Status,Photo", 
           ...records.map(r => r.map((v,i) => i===9 ? "[photo not in CSV]" : `"${v}"`).join(","))].join("\n");

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "audit_records.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
  </script>
</body>
</html>
