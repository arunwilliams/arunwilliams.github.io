<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EHS Audit Tool</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver/dist/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<style>
body { font-family: Arial, sans-serif; background:#f0f2f5; margin:0; padding:20px; }
.container { max-width:1200px; margin:auto; display:flex; flex-direction:column; gap:20px; }
.card { background:#fff; border-radius:10px; padding:20px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
.card h2 { color:#2e7d32; text-align:center; margin-bottom:20px; }
form .row { display:flex; flex-wrap:wrap; margin-bottom:10px; align-items:center; }
form .row label { flex:1 0 150px; font-weight:bold; }
form .row input, form .row select, form .row textarea { flex:2 0 300px; padding:5px; }
table { width:100%; border-collapse: collapse; margin-top:10px; }
table th, table td { border:1px solid #ccc; padding:8px; text-align:center; vertical-align:middle; word-break:break-word; }
table th { background:#2e7d32; color:#fff; position:sticky; top:0; z-index:1; }
.high-risk { background:#f8d7da; border:1px solid #f5c6cb; }
.medium-risk { background:#fff3cd; border:1px solid #ffeeba; }
.low-risk { background:#d4edda; border:1px solid #c3e6cb; }
.good-practice { background:#e8f5e9; border:1px solid #2e7d32; }
@media(max-width:768px){
  form .row { flex-direction:column; align-items:flex-start; }
  form .row label, form .row input, form .row select, form .row textarea { flex:1 0 100%; }
}
button { background:#2e7d32; color:#fff; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; margin-top:10px; }
button:hover { background:#1b5e20; }
img.audit-photo { max-width:50px; max-height:50px; object-fit:contain; display:block; margin:auto; }
</style>
</head>
<body>
<div class="container">
  <!-- Audit Form -->
  <div class="card">
    <h2><i class="fas fa-hard-hat"></i> Audit Form</h2>
    <form id="auditForm">
      <div class="row"><label>Audit Date:</label><input type="date" id="auditDate" required></div>
      <div class="row"><label>Auditor Name:</label><input type="text" id="auditorName" required></div>
      <div class="row"><label>Location/Site:</label><input type="text" id="location" required></div>
      <div class="row"><label>Observation:</label><textarea id="observation" required></textarea></div>
      <div class="row"><label>Nature of Hazard:</label><input type="text" id="hazardNature"></div>
      <div class="row"><label>Risk Category:</label>
        <select id="category" required>
          <option value="High Risk">High Risk</option>
          <option value="Medium Risk">Medium Risk</option>
          <option value="Low Risk">Low Risk</option>
          <option value="Good Practice">Good Practice</option>
        </select>
      </div>
      <div class="row"><label>Recommended Action:</label><textarea id="recommendedAction"></textarea></div>
      <div class="row"><label>Action Taken:</label><textarea id="actionTaken"></textarea></div>
      <div class="row"><label>Responsible Person:</label><input type="text" id="responsiblePerson"></div>
      <div class="row"><label>Target Date:</label><input type="date" id="targetDate"></div>
      <div class="row"><label>Status:</label>
        <select id="status">
          <option value="Open">Open</option>
          <option value="Closed">Closed</option>
        </select>
      </div>
      <div class="row"><label>Photo:</label><input type="file" id="photo"></div>
      <button type="submit"><i class="fas fa-plus"></i> Add Record</button>
    </form>
  </div>

  <!-- Audit Records -->
  <div class="card">
    <h2><i class="fas fa-table"></i> Audit Records</h2>
    <button id="exportBtn"><i class="fas fa-file-excel"></i> Export to Excel</button>
    <table id="recordsTable">
      <thead>
        <tr>
          <th>S.No</th><th>Audit Date</th><th>Auditor</th><th>Location</th><th>Observation</th>
          <th>Nature of Hazard</th><th>Risk Category</th><th>Recommended Action</th><th>Action Taken</th>
          <th>Responsible Person</th><th>Target Date</th><th>Status</th><th>Photo</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<canvas id="chartCanvas" width="400" height="150" style="display:none;"></canvas>

<script>
let records=[];
let persistentDate="", persistentAuditor="", persistentLocation="";

document.getElementById("auditForm").addEventListener("submit", function(e){
  e.preventDefault();
  const date=document.getElementById("auditDate").value;
  const auditor=document.getElementById("auditorName").value;
  const location=document.getElementById("location").value;
  const observation=document.getElementById("observation").value;
  const hazardNature=document.getElementById("hazardNature").value;
  const category=document.getElementById("category").value;
  const recommendedAction=document.getElementById("recommendedAction").value;
  const actionTaken=document.getElementById("actionTaken").value;
  const responsiblePerson=document.getElementById("responsiblePerson").value;
  const targetDate=document.getElementById("targetDate").value;
  const status=document.getElementById("status").value;
  const photoInput=document.getElementById("photo");
  const file=photoInput.files[0];

  const reader=new FileReader();
  reader.onload=function(e){
    const photoData=e.target.result;
    records.push({date,auditor,location,observation,hazardNature,category,recommendedAction,actionTaken,responsiblePerson,targetDate,status,photo:photoData});
    updateTable();
    persistentDate=date; persistentAuditor=auditor; persistentLocation=location;
  };
  if(file) reader.readAsDataURL(file);
  else { records.push({date,auditor,location,observation,hazardNature,category,recommendedAction,actionTaken,responsiblePerson,targetDate,status,photo:null}); updateTable(); persistentDate=date; persistentAuditor=auditor; persistentLocation=location;}
});

function updateTable(){
  const tbody=document.querySelector("#recordsTable tbody");
  tbody.innerHTML="";
  records.forEach((r,i)=>{
    const tr=document.createElement("tr");
    const riskClass=r.category==="High Risk"?"high-risk":r.category==="Medium Risk"?"medium-risk":r.category==="Low Risk"?"low-risk":"good-practice";
    tr.className=riskClass;
    tr.innerHTML=`<td>${i+1}</td><td>${r.date}</td><td>${r.auditor}</td><td>${r.location}</td><td>${r.observation}</td><td>${r.hazardNature}</td><td>${r.category}</td><td>${r.recommendedAction}</td><td>${r.actionTaken}</td><td>${r.responsiblePerson}</td><td>${r.targetDate}</td><td>${r.status}</td><td>${r.photo?`<img src="${r.photo}" class="audit-photo">`:''}</td>`;
    tbody.appendChild(tr);
  });
}

// Excel export function remains same as previous version with chart & risk colors
// Add your ExcelJS export code here following the earlier pattern

</script>
</body>
</html>
