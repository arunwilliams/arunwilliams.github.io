<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EHS Audit Data Collection</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f5f5f5;
    }
    h1 {
      text-align: center;
      color: #2e7d32;
    }
    form {
      background: #ffffff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 10px;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background: #2e7d32;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 15px;
    }
    button:hover {
      background: #1b5e20;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #ffffff;
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #2e7d32;
      color: white;
    }
    .risk-high { background-color: #ffcccc; color: #b71c1c; font-weight: bold; }
    .risk-medium { background-color: #fff3cd; color: #e65100; font-weight: bold; }
    .risk-low { background-color: #e0f7fa; color: #006064; font-weight: bold; }
    .good-practice { background-color: #e8f5e9; color: #1b5e20; font-weight: bold; }
    img { max-width: 100px; max-height: 70px; }
  </style>
</head>
<body>
  <h1>EHS Audit Data Collection</h1>

  <form id="auditForm">
    <label>Date:</label>
    <input type="date" name="date" required />

    <label>Auditor:</label>
    <input type="text" name="auditor" required />

    <label>Location:</label>
    <input type="text" name="location" required />

    <label>Observation:</label>
    <textarea name="observation" required></textarea>

    <label>Category:</label>
    <select name="category" required>
      <option value="High Risk">High Risk</option>
      <option value="Medium Risk">Medium Risk</option>
      <option value="Low Risk">Low Risk</option>
      <option value="Good Practice">Good Practice</option>
    </select>

    <label>Corrective Action:</label>
    <textarea name="action" required></textarea>

    <label>Responsible Person:</label>
    <input type="text" name="responsible" required />

    <label>Target Date:</label>
    <input type="date" name="target" required />

    <label>Status:</label>
    <select name="status" required>
      <option value="Open">Open</option>
      <option value="Closed">Closed</option>
    </select>

    <label>Upload Photo:</label>
    <input type="file" name="photo" accept="image/*" capture="environment" />

    <button type="submit">Add Audit</button>
  </form>

  <table>
    <thead>
      <tr>
        <th>S. No.</th>
        <th>Date</th>
        <th>Auditor</th>
        <th>Location</th>
        <th>Observation</th>
        <th>Category</th>
        <th>Action</th>
        <th>Responsible</th>
        <th>Target</th>
        <th>Status</th>
        <th>Photo</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <button id="downloadBtn">Download Excel</button>

  <script>
    const form = document.getElementById("auditForm");
    const tableBody = document.getElementById("tableBody");
    const downloadBtn = document.getElementById("downloadBtn");
    let records = [];

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(",")[1]);
        reader.onerror = error => reject(error);
      });
    }

    form.addEventListener("submit", async function(e) {
      e.preventDefault();
      const formData = new FormData(form);
      const row = [];

      // Auto-generate S.No.
      row.push(records.length + 1);

      formData.forEach((value, key) => {
        if (key !== "photo") row.push(value);
      });

      const file = formData.get("photo");
      let base64Img = "";
      let imgUrl = "";
      if (file && file.size > 0) {
        base64Img = await fileToBase64(file);
        imgUrl = URL.createObjectURL(file);
        row.push({ preview: imgUrl, base64: base64Img, mime: file.type });
      } else {
        row.push(null);
      }

      records.push(row);

      // Add row to table (UI)
      const tr = document.createElement("tr");
      row.forEach((cell, index) => {
        const td = document.createElement("td");

        if (index === 5) { // Category column
          td.textContent = cell;
          if (cell.includes("High Risk")) td.classList.add("risk-high");
          if (cell.includes("Medium Risk")) td.classList.add("risk-medium");
          if (cell.includes("Low Risk")) td.classList.add("risk-low");
          if (cell.includes("Good Practice")) td.classList.add("good-practice");
        } else if (index === 10 && cell) { // Photo
          const img = document.createElement("img");
          img.src = cell.preview;
          td.appendChild(img);
        } else {
          td.textContent = typeof cell === "string" || typeof cell === "number" ? cell : "";
        }

        tr.appendChild(td);
      });
      tableBody.appendChild(tr);

      form.reset();
    });

    downloadBtn.addEventListener("click", async function () {
      const workbook = new ExcelJS.Workbook();
      const sheet = workbook.addWorksheet("Audit Records");

      // Header row
      const header = ["S. No.", "Date", "Auditor", "Location", "Observation", "Category", "Action", "Responsible", "Target", "Status", "Photo"];
      sheet.addRow(header);
      sheet.getRow(1).font = { bold: true, color: { argb: "FFFFFFFF" } };
      sheet.getRow(1).fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FF2E7D32" } };

      // Data rows
      records.forEach((r, rowIndex) => {
        const excelRow = sheet.addRow(r.map((v, i) => (i === 10 ? "" : v)));

        // Category formatting
        const categoryCell = excelRow.getCell(6);
        if (r[5].includes("High Risk")) {
          categoryCell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFFFCCCC" } };
          categoryCell.font = { bold: true, color: { argb: "FFB71C1C" } };
        } else if (r[5].includes("Medium Risk")) {
          categoryCell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFFFF3CD" } };
          categoryCell.font = { bold: true, color: { argb: "FFE65100" } };
        } else if (r[5].includes("Low Risk")) {
          categoryCell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFE0F7FA" } };
          categoryCell.font = { bold: true, color: { argb: "FF006064" } };
        } else if (r[5].includes("Good Practice")) {
          categoryCell.fill = { type: "pattern", pattern: "solid", fgColor: { argb: "FFE8F5E9" } };
          categoryCell.font = { bold: true, color: { argb: "FF1B5E20" } };
        }

        // Insert photo
        if (r[10]) {
          const imageId = workbook.addImage({
            base64: `data:${r[10].mime};base64,${r[10].base64}`,
            extension: r[10].mime.split("/")[1],
          });
          sheet.addImage(imageId, {
            tl: { col: 10, row: rowIndex + 1 },
            ext: { width: 100, height: 70 },
          });
          sheet.getRow(rowIndex + 2).height = 55;
        }
      });

      // Column widths
      sheet.columns = [
        { width: 8 }, { width: 12 }, { width: 18 }, { width: 18 },
        { width: 30 }, { width: 18 }, { width: 25 }, { width: 20 },
        { width: 12 }, { width: 12 }, { width: 15 }
      ];

      const buffer = await workbook.xlsx.writeBuffer();
      saveAs(new Blob([buffer]), "audit_records_with_photos.xlsx");
    });
  </script>
</body>
</html>
